<VirtualHost *:8443>
    ServerName  odrs-dev.gnome.org 
    DocumentRoot /opt/app-root/src

    SSLEngine on
    SSLProtocol All -SSLv2 -SSLv3
    SSLCertificateFile /var/serving-cert/tls.crt
    SSLCertificateKeyFile /var/serving-cert/tls.key

    Alias /static/ /opt/app-root/src/odrs/static
    Alias /1.0/reviews/api/ratings /opt/app-root/src/odrs/static/ratings.json

    WSGIDaemonProcess odrs.gnome.org processes=10 threads=15 maximum-requests=100
    WSGIProcessGroup odrs.gnome.org

    WSGIScriptAlias / /opt/app-root/src/wsgi-scripts/odrs.wsgi

    SetEnv ODRS_REVIEWS_SECRET %{ENV:ODRS_REVIEWS_SECRET}
    SetEnv SQLALCHEMY_DATABASE_URI %{ENV:SQLALCHEMY_DATABASE_URI}

    <Directory /opt/app-root/src/odrs/static>
        ExpiresActive On
        ExpiresByType image/png "access plus 1 week"
        ExpiresByType application/javascript "access plus 1 week"
        ExpiresByType text/javascript "access plus 1 week"
        ExpiresByType text/css "access plus 1 day"
        ExpiresByType application/json "access plus 2 weeks"
        Header set Cache-Control "public"
    </Directory>

    <IfModule mod_headers.c>
        # Serve gzip/br compressed CSS and JS files if they exist
        # and the client accepts gzip/br.
        RewriteCond "%{HTTP:Accept-encoding}" "gzip"
        RewriteCond "%{REQUEST_FILENAME}\.gz" -s
        RewriteRule "^(.*)\.(js|css|json)"         "$1\.$2\.gz" [QSA]

        RewriteCond "%{HTTP:Accept-encoding}" "br"
        RewriteCond "%{REQUEST_FILENAME}\.br" -s
        RewriteRule "^(.*)\.(js|css|json)"         "$1\.$2\.br" [QSA]

        # Serve correct content types, and prevent double compression.
        RewriteRule "\.js\.gz$" "-" [T=application/javascript,E=no-gzip:1]
        RewriteRule "\.css\.gz$" "-" [T=text/css,E=no-gzip:1]
        RewriteRule "\.json\.gz$" "-" [T=application/json,E=no-gzip:1]

        RewriteRule "\.js\.br$" "-" [T=application/javascript,E=no-brotli:1]
        RewriteRule "\.css\.br$" "-" [T=text/css,E=no-brotli:1]
        RewriteRule "\.json\.br$" "-" [T=application/json,E=no-brotli:1]

        <FilesMatch "(\.js\.gz|\.css\.gz|\.json\.gz)$">
            # Serve correct encoding type.
            Header append Content-Encoding gzip

            # Force proxies to cache gzipped &
            # non-gzipped files separately.
            Header append Vary Accept-Encoding
        </FilesMatch>

        <FilesMatch "(\.js\.br|\.css\.br|\.json\.br)$">
            # Serve correct encoding type.
            Header append Content-Encoding br

            # Force proxies to cache brotlied &
            # non-brotlied files separately.
            Header append Vary Accept-Encoding
        </FilesMatch>
    </IfModule>
</VirtualHost>

<Directory "/opt/app-root/src/odrs/static">
  AllowOverride None

  Require all granted
</Directory>

<Directory "/opt/app-root/src/wsgi-scripts">
  Require all granted
</Directory>
